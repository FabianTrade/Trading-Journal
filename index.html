<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - Cloud Sync</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; background: #0f172a; color: white; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 5px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CLOUD KONFIGURATION ---
        const SUPABASE_URL = 'https://epomvhikguclvpagzxhm.supabase.co';
        const SUPABASE_KEY = 'DEIN_KOPIERTER_ANON_KEY'; // <--- HIER DEINEN KEY EINSETZEN!
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Icons
        const PlusCircle = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth="2"/><path d="M12 8v8M8 12h8" strokeWidth="2" strokeLinecap="round"/></svg>);
        const TrendingUp = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 7l5 5m0 0l-5 5m5-5H6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>);
        const TrendingDown = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 17l5-5m0 0l-5-5m5 5H6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>);

        const TradingJournal = () => {
            const [trades, setTrades] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingTrade, setEditingTrade] = useState(null);
            const [filter, setFilter] = useState('all');
            const [loading, setLoading] = useState(true);
            const [formData, setFormData] = useState({
                entryDate: '', entryTime: '', exitDate: '', exitTime: '',
                direction: 'long', instrument: '', entryPrice: '', exitPrice: '',
                positionSize: '', stopLoss: '', takeProfit: '', setup: '',
                result: '', resultPercent: '', rMultiple: '', notes: '', deviatedFromPlan: false
            });

            // Cloud: Trades laden
            useEffect(() => {
                fetchTrades();
            }, []);

            async function fetchTrades() {
                setLoading(true);
                const { data, error } = await _supabase
                    .from('trades')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) console.error("Ladefehler:", error);
                else setTrades(data || []);
                setLoading(false);
            }

            const handleSubmit = async (e) => {
                e.preventDefault();
                const tradeToSave = { ...formData };
                
                if (editingTrade) {
                    const { error } = await _supabase.from('trades').update(tradeToSave).eq('id', editingTrade.id);
                    if (error) alert(error.message);
                } else {
                    const { error } = await _supabase.from('trades').insert([tradeToSave]);
                    if (error) alert(error.message);
                }
                
                resetForm();
                fetchTrades();
            };

            const resetForm = () => {
                setFormData({
                    entryDate: '', entryTime: '', exitDate: '', exitTime: '',
                    direction: 'long', instrument: '', entryPrice: '', exitPrice: '',
                    positionSize: '', stopLoss: '', takeProfit: '', setup: '',
                    result: '', resultPercent: '', rMultiple: '', notes: '', deviatedFromPlan: false
                });
                setShowForm(false);
                setEditingTrade(null);
            };

            const deleteTrade = async (id) => {
                if (confirm('Trade wirklich löschen?')) {
                    await _supabase.from('trades').delete().eq('id', id);
                    fetchTrades();
                }
            };

            // Statistik-Berechnung (Lokal auf Basis der Cloud-Daten)
            const getStats = () => {
                if (trades.length === 0) return null;
                const winners = trades.filter(t => parseFloat(t.result) > 0);
                const losers = trades.filter(t => parseFloat(t.result) < 0);
                const totalPnL = trades.reduce((sum, t) => sum + parseFloat(t.result || 0), 0);
                const winRate = ((winners.length / trades.length) * 100).toFixed(1);
                return { winners, losers, totalPnL, winRate };
            };

            const stats = getStats();

            return (
                <div className="min-h-screen bg-slate-900 text-gray-100 p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        <h1 className="text-3xl font-bold mb-8 bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
                            Trading Journal Cloud
                        </h1>

                        {stats && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                <div className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                    <span className="text-gray-400 text-sm">Gesamt P&L</span>
                                    <div className={`text-2xl font-bold ${stats.totalPnL >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                        {stats.totalPnL.toFixed(2)}€
                                    </div>
                                </div>
                                <div className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                    <span className="text-gray-400 text-sm">Gewinnquote</span>
                                    <div className="text-2xl font-bold text-blue-400">{stats.winRate}%</div>
                                </div>
                            </div>
                        )}

                        <button onClick={() => setShowForm(!showForm)} className="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold mb-6 flex items-center gap-2">
                            <PlusCircle /> {showForm ? 'Schließen' : 'Neuer Trade'}
                        </button>

                        {showForm && (
                            <form onSubmit={handleSubmit} className="bg-slate-800 p-6 rounded-lg border border-slate-700 mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" placeholder="Instrument (z.B. Uranium Energy)" required className="bg-slate-900 p-2 rounded border border-slate-600" value={formData.instrument} onChange={e => setFormData({...formData, instrument: e.target.value})} />
                                <select className="bg-slate-900 p-2 rounded border border-slate-600 text-white" value={formData.direction} onChange={e => setFormData({...formData, direction: e.target.value})}>
                                    <option value="long">Long</option>
                                    <option value="short">Short</option>
                                </select>
                                <input type="number" step="any" placeholder="Einstiegspreis" required className="bg-slate-900 p-2 rounded border border-slate-600" value={formData.entryPrice} onChange={e => setFormData({...formData, entryPrice: e.target.value})} />
                                <input type="number" step="any" placeholder="Ergebnis €" className="bg-slate-900 p-2 rounded border border-slate-600" value={formData.result} onChange={e => setFormData({...formData, result: e.target.value})} />
                                <textarea placeholder="Setup & Notizen" className="md:col-span-3 bg-slate-900 p-2 rounded border border-slate-600" value={formData.setup} onChange={e => setFormData({...formData, setup: e.target.value})}></textarea>
                                <button type="submit" className="bg-emerald-600 p-2 rounded font-bold">Speichern</button>
                            </form>
                        )}

                        <div className="space-y-4">
                            {loading ? <p>Lade Daten aus Cloud...</p> : trades.map(trade => (
                                <div key={trade.id} className="bg-slate-800 p-4 rounded-lg border border-slate-700 flex justify-between items-center">
                                    <div>
                                        <span className={`text-xs font-bold px-2 py-1 rounded ${trade.direction === 'long' ? 'bg-emerald-900 text-emerald-400' : 'bg-red-900 text-red-400'}`}>
                                            {trade.direction.toUpperCase()}
                                        </span>
                                        <h3 className="text-xl font-bold mt-1">{trade.instrument}</h3>
                                        <p className="text-gray-400 text-sm">Einstieg: {trade.entryPrice}€</p>
                                    </div>
                                    <div className="text-right">
                                        <div className={`text-xl font-bold ${parseFloat(trade.result) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                            {trade.result}€
                                        </div>
                                        <button onClick={() => deleteTrade(trade.id)} className="text-gray-500 hover:text-red-400 text-sm mt-2">Löschen</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TradingJournal />);
    </script>
</body>
</html>
